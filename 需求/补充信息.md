# 需求补充信息

本文档补充了需求中未明确说明的技术细节和业务逻辑，供开发参考。

## 一、技术选型补充

### 1.1 后端框架
- **问题**：需求中只提到使用Python，未明确框架
- **建议**：使用 **FastAPI**
  - FastAPI优势：自动生成API文档、类型检查、异步支持

### 1.2 ChromaDB配置
- **问题**：未明确ChromaDB的连接配置和集合命名
- **补充信息**：
  - **连接方式**：本地持久化存储（PersistentClient）
  - **数据存储路径**：建议 `./data/chroma_db`
  - **集合（Collection）名称**：建议使用固定名称 `"table_documents"` 

### 1.3 相似度匹配算法
- **问题**：使用ChromaDB的 `query` 方法进行向量相似度搜索
- **补充信息**：
  - 使用ChromaDB的 `query` 方法进行向量相似度搜索
  - 默认返回最相似的N个结果（N=4，可配置）
  - 建议设置相似度阈值（score threshold）过滤低质量匹配

### 1.4 XML与HTML转换
- **问题**：使用正则做标签替换的具体规则未明确
- 这两个转换先以TODO作为占位符

## 二、前端补充信息

### 2.1 UI框架
- **问题**：未明确Vue2使用的UI组件库
- **建议**：
  - **Element UI**（推荐）：成熟稳定，组件丰富

### 2.2 页面布局
- **问题**：未明确页面布局和样式要求
- **补充信息**：
  - **上传页面**：居中布局，上传区域、文件列表展示
  - **展示页面**：
    - 顶部：搜索框、导航按钮
    - 左侧/中间：主展示区域（iframe，宽度建议70-80%）
    - 右侧：顺序调换面板（可收起/展开，宽度建议20-30%）
    - 底部：匹配表格预览区域（横向滚动，每个预览宽度建议200-300px）
  - 响应式设计：建议支持最小宽度1200px

### 2.3 iframe和预览区域
- **问题**：未明确iframe和预览的尺寸、样式
- **补充信息**：
  - **主展示iframe**：
    - 宽度：100%（父容器）
    - 高度：建议600-800px（可滚动）
    - 边框：1px solid #ddd
    - 背景：白色
  - **预览区域**：
    - 每个预览iframe：宽度250px，高度200px
    - 横向滚动布局
    - 鼠标悬停高亮
    - 选中状态：边框加粗或背景色变化

### 2.4 sessionStorage规范
- **问题**：未明确sessionStorage的key命名和数据结构
- **补充信息**：
  - **Key命名**：建议使用 `"selected_tables"` 或 `"table_selection"`
  - **数据结构**：建议使用JSON数组
    ```javascript
    // 存储格式
    {
      "tableIds": ["文件名_1", "文件名_2", "文件名_3"],
      "order": ["文件名_1", "文件名_2", "文件名_3"]  // 顺序数组
    }
    ```
  - **更新时机**：
    - 加表格时：添加到数组
    - 从右侧展示面板点击减按钮时：从数组移除
    - 调整顺序时：更新order数组
    - 下载完成后：清空sessionStorage

### 2.5 表格ID格式
- **问题**：未明确表格ID的具体格式
- **补充信息**：
  - **格式**：`{文件名}_{序号}`（如：`"报告_1"`, `"报告_2"`）
  - **文件名处理**：去除扩展名（.docx），特殊字符建议用下划线替换
  - **序号**：从1开始，按文档中表格出现顺序递增
  - **唯一性**：确保同一文档中表格ID唯一

## 三、接口规范补充

### 3.1 上传接口 `/upload`
- **请求**：
  - 方法：`POST`
  - Content-Type：`multipart/form-data`
  - 参数：`file`（文件对象）
- **响应格式**：
  ```json
  {
    "code": 200,
    "message": "上传成功",
    "data": {
      "filename": "报告.docx",
      "tables_count": 5,
      "table_ids": ["报告_1", "报告_2", "报告_3", "报告_4", "报告_5"]
    }
  }
  ```
- **错误响应**：
  ```json
  {
    "code": 400,
    "message": "文件格式不支持，仅支持.docx文件",
    "data": null
  }
  ```

### 3.2 查询接口 `/page`
- **请求**：
  - 方法：`GET` 或 `POST`
  - 参数：
    - `page_num`：页码（从1开始）
    - `page_size`：每页数量（默认4）
    - `query`：搜索关键字（字符串）
- **响应格式**：
  ```json
  {
    "code": 200,
    "message": "查询成功",
    "data": {
      "total": 20,
      "page_num": 1,
      "page_size": 4,
      "tables": [
        {
          "table_id": "报告_1",
          "html": "<table>...</table>",
          "score": 0.85,
          "filename": "报告.docx"
        },
        // ... 更多表格
      ]
    }
  }
  ```

### 3.3 下载接口 `/download`
- **请求**：
  - 方法：`POST`
  - Content-Type：`application/json`
  - 参数：
    ```json
    {
      "table_ids": ["id1", "id2", "id3"]
    }
    ```
    这里的id是chromadb的ids里面的值
- **响应**：
  - Content-Type：`application/vnd.openxmlformats-officedocument.wordprocessingml.document`
  - 文件名：建议使用 `"tables_{timestamp}.docx"` 或 `"合并表格.docx"`
  - 格式：Blob二进制流

### 3.4 错误码定义
- **建议错误码**：
  - `200`：成功
  - `400`：请求参数错误
  - `404`：资源不存在
  - `500`：服务器内部错误
  - `413`：文件过大

## 四、业务逻辑补充

### 4.1 表格段落提取逻辑
- **问题**：需求中提到"表格前三个段落和后一个段落"，边界情况未明确
- **补充信息**：
  - **表格前段落**：
    - 如果表格前不足3个段落，提取所有可用段落
    - 段落定义：`<w:p>` 元素
    - 排除空段落（仅包含空白字符）
  - **表格后段落**：
    - 如果表格后没有段落，不提取
    - 只提取紧邻表格的第一个段落
  - **段落顺序**：保持原文档中的顺序

### 4.2 文件大小限制
- **问题**：未明确文件大小限制
- **建议**：
  - **前端限制**：10MB（通过input的accept和文件大小检查）
  - **后端限制**：50MB（可配置）
  - **超限处理**：返回413错误，提示用户文件过大

### 4.3 错误处理机制
- **问题**：未明确各种错误情况的处理方式
- **补充信息**：
  - **文件格式错误**：前端和后端双重校验，返回400错误
  - **文件解析失败**：返回500错误，记录日志
  - **ChromaDB连接失败**：返回500错误，提示系统错误
  - **表格提取失败**：记录警告日志，跳过该表格，继续处理其他表格
  - **下载组装失败**：返回500错误，提示下载失败

### 4.4 表格分割逻辑（TODO部分）
- **问题**：核心分割部分用TODO代替，需要明确分割策略
- **补充信息**：
  - **分割目标**：将文档按表格分割成独立的文档块
  - **分割单位**：每个表格及其上下文段落作为一个独立单元
  - **存储策略**：每个分割单元作为一个document存入ChromaDB
  - **metadata结构**：
    ```python
    {
      "table_xml": "<w:tbl>...</w:tbl>",
      "styles_xml": "<w:styles>...</w:styles>",
      "before_paragraphs": ["<w:p>...</w:p>", ...],
      "after_paragraph": "<w:p>...</w:p>",
      "filename": "报告.docx",
      "table_index": 1
    }
    ```

## 五、开发环境补充

### 5.1 Python环境
- **Python版本**：建议 Python 3.8+
- **依赖包**：
  - `fastapi` 或 `flask`
  - `uvicorn`（FastAPI）或 `gunicorn`（Flask）
  - `python-multipart`（文件上传）
  - `chromadb`
  - `lxml`（XML解析）
  - `python-docx`（可选，用于验证）
  - `zipfile`（Python标准库）

### 5.2 前端环境
- **Python版本**：建议python >= 3.8
- **Vue版本**：Vue 2.x
- **依赖包**：
  - `vue@2.x`
  - `vue-router@3.x`（页面路由）
  - `axios`（HTTP请求）
  - `element-ui` 或选择的UI框架

## 六、性能要求补充

### 6.1 响应时间
- **上传接口**：建议10MB文件在5秒内完成解析和存储
- **查询接口**：建议在1秒内返回结果
- **下载接口**：建议在3秒内生成并返回文件

### 6.2 并发处理
- **问题**：未明确并发要求
- **建议**：
  - 支持至少10个并发上传请求
  - 查询接口支持更高并发（50+）
  - 使用异步处理大文件上传

### 6.3 数据存储
- **ChromaDB存储**：建议定期清理或提供数据管理接口
- **文件存储**：不保存原始文档，仅保存提取的表格数据

## 七、其他补充

### 7.1 日志记录
- **建议记录**：
  - 用logging将日志存入本地
  - 文件上传日志（文件名、大小、处理时间）
  - 查询日志（关键字、结果数量）
  - 错误日志（详细错误信息、堆栈）
  - 下载日志（表格ID列表、生成时间）

### 7.2 安全性
- 本地demo，暂不考虑安全性

### 7.3 部署要求
- **问题**：未明确部署环境
- **建议**：
  - 环境：本地运行即可

### 7.4 测试要求
- **单元测试**：核心功能（表格提取、XML转换）
- **集成测试**：接口测试（上传、查询、下载）
- **前端测试**：页面交互、数据流

---

## 待确认问题

1. **表格ID的唯一性**：如果多个文档有相同文件名，如何处理ID冲突？
2. **段落提取的精确性**：是否需要考虑表格嵌套在段落中的情况？
3. **样式提取的完整性**：是否需要提取表格内文本的段落样式和字符样式？
4. **预览数量**：默认返回4个表格，是否可以配置？
5. **下载文件命名**：用户是否可以自定义下载文件名？
6. **数据持久化**：ChromaDB数据是否需要备份机制？
7. **多语言支持**：是否需要支持英文界面？

---

**最后更新**：请根据实际开发情况补充和更新本文档。

